# Reversing

[アセンブリ言語入門](http://ext-web.edu.sgu.ac.jp/koike/CA14/assembler_content.html)
## 汎用レジスタ
| reg | Tutorials               |
|:---:|:----------------------- |
| `EAX` | アキュームレータ。計算処理の実行。**関数戻り値の格納**。|
| `EDX` |データレジスタ。EAXの拡張に使用。 |
| `ECX` |ループ処理用カウンタレジスタ。下方向にカウントする。 |
| `ESI` | **文字列コピーの際のコピー元アドレス**。ループ処理用データレジスタ。ソースインデックス。入力データストリームの位置を記憶。 | 
| `EDI` | **文字列コピーの際のコピー先アドレス**。ループ処理用データレジスタ。ディスティネーションインデックス。データ処理結果格納位置のポインタ。|
| `ESP` |スタックポインタ|
| `EBP` |ベースポインタ|
| `EBX` |計算用|
| `EIP` |次に実行されるアドレスが入る|

## 代表的な命令
### 代入命令
| Ope code | description |
|:--------:|-------------|
|`mov`|値をコピーする。実数値などで使われやすい。|
|`lea`<br>(Load Effective Address)|アドレスをコピーする。ポインタなどで使われやすい。|<br>

[00410000] 00000100 <br>
- mov eax, [00410000] -> eax = 00000100<br>
- lea eax, [00410000] -> eax = 00410000<br>



## ジャンプ命令
| Ope code | description |
|:--------:|-------------|
|`cmp`| 二つの値を比較する。結果はZFに反映され、一致したとき1、それ以外０|
|`test`|and命令とほぼ同じだが結果は保持しない。主にZFを変動させる目的で使われる。|

|Ope clde| cmp A, Bの時、 |
|--|----------------------------|
|`JZ`| A - B = 0 なら指定位置にジャンプ|
|`JG`|A > B なら指定位置にジャンプ|
|`JL`|A < B なら指定位置にジャンプ|
|`JE`|A=Bなら指定位置にジャンプ|
|`JNE`|!(A=B)|

## IDA
[IDAPro cheatsheet](https://www.hex-rays.com/products/ida/support/freefiles/IDA_Pro_Shortcuts.pdf)
### Settings to be checked first
- OPTION TAB
    - General -> Disassembly -> Display disassembly line parts<br>

|Settings|description|
|--------|-----------|
|Line prefix|Display a Prefix for each instruction in the graph view|
|Stack pointe|Displays where data was stacked when it was stacked|
|Comments|Comments|
|Repeatable comments|When the same function, etc. is called elsewhere, insert a comment there as well|
### Shortcut
#### Frequently used basic shortcuts
|Keys|description|
|:--:|-----------|
|```x```|List where functions, strings, etc. are referenced|
|```Enter```|Go to the address of that function or string|
|```esc```|Back to Previous|
|```space```|Swap between text and graph views|
#### Display Change
- When you find a suspicious area<br>

|Keys|description|
|:--:|-----------|
|```U```|Set the selected area to "undefined".|
|```C```|Make the selected area "code".|
|```D```|Make the selected area "data".|
|```P```|Make selected partial data a "function".|
|```A```|Make the selected area "string".|
|```*```|Make the selected area "Array".|

- Function to leave comments on code read by IDA<br>

|Keys|description|
|:--:|-----------|
|```N```|Redefine function and variable names|
|```:```| Can add comments.|
|```;```| Repeatable comments can be added (if the same code is referenced elsewhere, it will be reflected there as well)|
|```Y```| Prototype declarations for functions (automatically comments argument names)|

- Use when there are suspicious hexadecimal numbers in mov, etc.

|Keys|description|
|:--:|-----------|
|```B```| Switch between hexadecimal and binary display|
|```H```| Toggles between hexadecimal and decimal display|
|```R```| Toggles between hexadecimal and ASCII character display|

### Tabs
- Output window
    - ログ出力結果
    - Alt + 0
- Function window
    - 関数一覧
    - Alt + 1
- IDA View-A window
    - メインとなるウインドウ
    - テキストビューとグラフビューが存在する
        - 解析者の間では、どちらが見やすいかで議論になる(らしい
    - Alt + 2
- Strings window
    - 解析対象ファイルに含まれる文字列一覧
    - Alt + 3
- Hex View-1
    - 解析対象ファイルの16進数表示とそのascii表示
    - Alt + 4
- Structures
    - Alt + 5
- Enums
    - Alt + 6
- Imports
    - Importされている関数一覧
    - Alt + 7
- Exports
    - Exportされている関数一覧
    - Alt + 8



## strace
[strace でプログラムの動きを追ってみよう](https://tech-lab.sios.jp/archives/17394)
```
$ strace <コマンド>
$ trace -p <プロセスの PID>
```

## radre2
[radare2の使い方 | リバースエンジニアリング入門#5](https://www.bioerrorlog.work/entry/reverse-engineering-ep5-radare2)
[radare2 覚書](https://takuzoo3868.hatenablog.com/entry/radare2_love)

|command| |
|-------|-|
|

## angr
[angr on PythonをCTFに使う](https://saotake.hatenablog.com/entry/2016/06/03/213100)
angrはPython仮想環境で使う。
```
$ cd [project dir]
$ python3 -m venv angr
　　#仮想環境のアクティベート
$ source  ~/angr/bin/activate
　　#angrのインストール
(angr)$ pip install angr
　　#仮想環境の終了
(angr)$ deactivate
```

## .NETの逆コンパイル
.NETアプリケーションはソースコードを容易に確認することができます。
[dnSpy](https://github.com/dnSpy/dnSpy/releases)
[my_arthenal link](https://drive.google.com/drive/folders/1nI3lr5tFQIuTchrwasLKQvHLHGfFvjZp?usp=sharing)

## 表層解析
### PEview
実行ファイルのヘッダ確認（作成時期とか）


## 動的解析
### 実行プロセス(API)の確認
[API Monitor](http://www.rohitab.com/downloads)
[my_arthenal link](https://drive.google.com/drive/folders/1wL1f_zc2zT56py-ij0WOFnlDMg6fDpDJ?usp=sharing)
API Monitorを管理者権限で起動して、左上の「API Filter」で以下に示した関数群
のみチェックを入れてください。

「EnumProcesses」・・PCで実行されいてるプロセス一覧の取得
「OpenProcess」・・プロセスにアタッチ
「GetModuleFileNameEx」・・プロセス名取得
「GetModuleFileName」・・プロセス名取得
「File」 メニューの「Monitor New Processes…」から検体（SonyDay.exe）を指定
して「OK」を押すとプログラムが実行され 検体からコールされた上記Widnows APIが
表示されます。
### コマンドラインの確認
Windows上で実行されたコマンドラインを記録する
[Sysmon](https://docs.microsoft.com/ja-jp/sysinternals/downloads/sysmon)
ダウンロードしたSysmon.exeを任意のフォルダ配置して以下のコマンドを実行してください。
```
C:\temp> sysmon.exe -i
```
サービスが開始されると、イベントログに操作ログが出力されるようになります。
イベントビューアから「アプリケーションとサービスログ」-「Microsoft」-「Windows」-「Sysmon」-「Operational」
```
Sysmon -u（アンインストール）
```

